---
title: "バッチ処理が異常終了する場合に「1回限り再実行」でタイミング起因の失敗を無害化する"
emoji: "⌨"
type: "tech"
topics: ["cmd", "windows", "cli"]
published: false
---

## 抄録

特定名称のファイル取得バッチが、上流の生成タイミングと競合して異常終了するケースがあった。管理者権限とタスクスケジューラが使用可能な前提のもと、失敗時に一度だけ遅延再実行する方式を採用。再帰的リトライは抑止し、冪等性と観測可能性を担保した。結果、タイミング起因の失敗は運用影響ゼロで吸収できた。

### 背景と目的

* 背景: ダウンロード対象ファイルの生成時刻が揺らぐため、実行タイミング次第で取得に失敗する事象が散発。
* 目的: 「運用手順を増やさず」「上流に手を入れず」に、タイミング起因の失敗を無害化する。

### 指標（SLI/SLO）

* SLI: バッチの**期限内成功率**、重複ダウンロード**発生件数**、**再実行回数**。
* SLO（本件の目標）: 期限内成功率 ≥ **\[目標値]**%、重複ダウンロード 0 件/月、再実行回数は\*\*\[閾値]\*\*件/月以下。

### 制約

* 管理者権限は使用可能。
* PowerShell 利用可。既存のダウンロード処理は Ruby 製で、保守契約の対象外。全改修は不可。
* 上流システムの時刻変更は困難。

### 代替案と評価軸

| 代替案 | 効果 | 影響範囲 | 工数/期間 | リスク | 判定 |
| --- | --- | --- | --- | --- | --- |
| PowerShell で全体を改修 | 高  | 広い | 大 | 既存仕様の巻き取りが重い | 不採用 |
| タスク実行時刻を固定で後ろへずらす | 中 | 狭い | 小 | 上流遅延のばらつきに追随できない | 不採用 |
| `Ruby` 側の実装を改修 | 高  | 広い | 大 | 契約外で実施不可 | 不採用 |
| **失敗時のみ“一度だけ”遅延再実行** | 中  | 狭い | 小 | 設計を誤ると再帰ループ | **採用** |

**決定理由**

* 既存の社内資材で実装可能、変更範囲が狭い。
* 管理者権限の前提下でタスクスケジューラ運用と親和性が高い。
* 上流仕様や既存アプリの大改修を避けつつ、SLOを満たせる。

### 設計の要点（重要な差分）

* **遅延再実行は“6分後”固定**
  根拠は上流/下流のジョブ編成。直後に\*\*+5分**と**+10分**の定期タスクが存在するため、衝突せず最短で入れられるスロットが**+6分**のみ。速度より**非競合\*\*を優先した決定。
  ※数値は構成依存。将来スケジュールが変わる場合は設定値で切り替え可能にする。
* **再帰防止フラグ**
  1回限りの再実行を保証するため、再実行予約時に\*\*一意なフラグ（タスク引数や一時ファイル名）\*\*を立て、フラグ検出時は再予約しない。
* **冪等性の担保**
  既取得ファイルが存在する場合は**スキップ**または\*\*原子置換（テンポラリ→リネーム）\*\*で重複格納や途中書き込みを防止。
* **排他制御**
  元ジョブと再実行ジョブの**多重起動禁止**を明示（ロックファイル/タスク設定の「既存インスタンスがある場合は開始しない」等）。
* **観測可能性**
  失敗・再実行予約・再実行成功を**別イベント**でログ出力し、月次で「再実行件数」を集計できるようにする。

### 結果（数字）

> ここは実測で埋める。前提と対象期間を併記。

* 期限内成功率: **\[修正前 A%] → \[修正後 B%]**（期間: **\[YYYY-MM-DD〜YYYY-MM-DD]**）
* 再実行発生率: **\[C件/月]**（閾値 **\[T件]** 以下）
* 重複ダウンロード件数: **0 件**
* 運用手順の追加: **0 本**（自動復帰）

### 失敗と再発防止

* **スロット衝突の再発**
  将来的に+5/+10分タスクの時刻変更や増設があると、6分スロットと衝突するリスク。
  対策: 6分はハードコードせず**設定値**にし、ジョブ編成変更時のレビュー項目に「再実行スロットの再計算」を入れる。
* **再帰ループ化**
  フラグの消し忘れや例外経路で、2回目以降も予約が走る可能性。
  対策: 再実行タスク名に**一意キー**を含め、登録済みチェックで弾く。終了時の**フラグ確実削除**をテストで担保。
* **処理時間のはみ出し**
  元ジョブが長引いて+10分タスクと鉢合わせするケース。
  対策: 元ジョブ/再実行ともに**最大実行時間**を定義し、超過時は安全に中断。タスクスケジューラの同時実行ポリシーは「開始しない」を選択。
* **上流遅延が6分を超える**
  稀に吸収しきれない遅延が発生する可能性。
  対策: 再実行件数の月次集計に**閾値**を設定し、超過したらスロット再調整か上流通知フック検討へ進める。
* **部分ダウンロードの重複**
  途中まで落ちたファイルを再取得して二重保存。
  対策: **サイズ/ハッシュ検証**で完全性を確認し、合格時のみ確定保存。

### 妥当性の脅威

* 観測期間が短いと季節要因を取りこぼす可能性。
* 上流メンテナンス日などの特殊日が外れ値になる。
* 監視対象外の失敗モード（権限エラー等）は本方式の適用外。

### 次やること

* 再実行件数が\*\*\[閾値]\*\*を超えた場合のアラートを追加。
* 上流側の生成完了通知が得られた場合は、将来的に**ポーリング→イベント駆動**へ移行。
* ダウンロード完了の**完全性検証**（サイズ/ハッシュ）をダッシュボード化。

### 証拠リンク

* 設計差分の PR / チケット: **\[リンク]**
* タスクスケジューラの設定差分スクリーンショット: **\[画像リンク]**
* ログ集計結果（再実行件数・成功率）: **\[ダッシュボード/画像リンク]**
