---
title: "Windowsバッチサーバー運用保守PJ"
---

## Windowsバッチサーバー運用保守PJ

### 概要

#### ドメイン

人事・総務系の社内業務システム（勤怠・経費・資格情報・ヘルスケア等）の定期更新処理を担う Windows バッチサーバの運用保守。

#### 目的

- 前担当者からの運用保守業務の引継ぎと、既存バッチ処理の安定運用の継続
- CSV ファイルのアップロード／ダウンロード結果の監視と、失敗時の対応
- バッチスクリプト／PowerShell のリファクタリングによる保守性・読みやすさの向上
- 障害・バグ発生時の原因調査と恒久対応による運用リスクの低減

#### 構成

Windows Server ＋ タスク スケジューラ ＋ バッチスクリプト（`.bat`/`.cmd`）  
＋ PowerShell ＋ Ruby ＋ CSV ファイル連携

### 案件情報

期間：2024/12 〜 現在  

体制：PM 1名、SE 1〜3名からなる 2〜4名の受託開発チーム。(時期により変動)

自分の役割：Windows バッチ／PowerShell の改修・調査・日次運用、障害対応など、バッチサーバの運用保守全般を担当。  
※ Ruby 部分は保守契約の対象外のため、調査・影響範囲の把握のみにとどめた。

### 担当業務

- タスク スケジューラで定期実行されるバッチ処理の結果監視（成功／失敗の確認）
- サーバメンテナンス期間前後における登録タスクの停止・再開、および実行順序の確認
- バッチスクリプト失敗時の一次切り分け（対象ジョブ・ファイル・環境要因の特定）と、再実行などによる復旧対応

### 技術スタック

**言語・スクリプト:** Windows バッチ, PowerShell

**OS:** Windows Server

**ツール:** VS Code, サクラエディタ, タスク スケジューラ, Windows Virtual Desktop

### Key ADR

#### ADR-01: バッチ実行時刻競合起因エラーの原因調査・不具合解消

##### 背景

特定のバッチタスクの実行時刻が、ほかのジョブと重なる時間帯に設定されており、リトライを含めて同じ時間帯に集中して実行されることで、タスクが失敗を繰り返す事象が発生していた。

- 過剰なタスク予約を防ぐため、リトライは1回までとする。  
- 実行時刻の「6分後」にリトライタスクを生成し、きりの良い時刻を避けて他タスクとの競合を減らす。  
- 不具合が起きているタスクのみをリトライ対象とし、関係ないタスクは再実行しない。

##### 評価軸

| 評価軸 | 案A：問題タスクのみを6分後に1回だけリトライ | 案B：リトライ回数を増やし一定間隔で再実行 | 案C：全タスクの実行時刻を見直しスケジュール再設計 |
|---|---|---|---|
| 実行時刻の競合回避 | 〇 競合時間帯を少しずらすことで集中を緩和できる | △ 実行回数が増え、かえって集中する可能性がある | ◎ 全体設計を見直すため競合を大きく減らせる |
| 既存タスク群への影響範囲 | ◎ 問題タスクとそのリトライのみ変更で済む　| 〇 設定変更は限定的で、他タスクへの影響は小さい | ✕ 多数のタスクの時刻や依存関係を変更する必要がある |
| 運用・設定変更の手間／ミスの起きにくさ | 〇 変更箇所が少なく、設定ミスも比較的抑えやすい | △ リトライ条件や監視の見直しが必要で手間が増える | ✕ 調整・検証の工数が大きく、設定ミスのリスクも高い |

##### 採否

- **案A：問題のタスクのみ 6分後に1回だけリトライする**  
  → **採用**

- **案B：リトライ回数を増やし、一定間隔で再実行する**  
  → **却下**

- **案C：全タスクの実行時刻を見直し、スケジュールを再設計する**  
  → **却下**

##### 却下理由

- **案B：リトライ回数を増やし、一定間隔で再実行する**  
  リトライ回数を増やすと、一時的に失敗が減る可能性はあるが、同じ時間帯にタスクが集中する状況そのものは変わらない。  
  環境負荷が高い時間帯にさらにタスクを投入することになり、かえって失敗を増やしたり、タスク予約が過剰になるおそれがあると判断したため採用しないことにした。

- **案C：全タスクの実行時刻を見直し、スケジュールを再設計する**  
  競合自体は減らせるが、すべてのジョブの開始時刻や依存関係を洗い直す必要があり、影響範囲が広い割に今回の不具合は特定タスクに限定されていた。  
  他タスクの担当者とも調整が必要となり、工数と調整コストが大きいことから、本インシデントの対応方針としては現実的でないと判断し、採用しないことにした。


#### ADR-02: データセンター移行に伴う集中バッチサーバーの停止／再開

##### 背景

データセンター移行に伴い、Windows バッチサーバ上のタスク スケジューラと、関連する cron ジョブを計画停止・再開する必要があった。  
タスク スケジューラの停止はシステム全体に影響するため、誤った無効化や復旧漏れが発生すると、定期バッチが長期的に動かなくなるリスクがあった。  
一部の停止操作はシステム側で無効化される挙動もあり、単純な「強制停止」コマンドだけでは安全性と再現性を担保しにくい状況だった。

そのため、Windows バッチサーバでは次の方式を採用した。

- 実行方式：PowerShell ＋ タスク スケジューラ  
  1. 各タスクの状態（有効／無効）のバックアップ用 XML を取得する  
  2. 監査用に、タスク一覧のみを抽出した CSV ファイルを XML から生成する  
  3. 対象タスクを一括で停止（無効化）する  
  4. バックアップ CSV をもとに、タスクの状態を元の有効／無効に復元する  

なお、cron ジョブについては、別件「社内向け Ubuntu サーバ運用保守」の範囲とし、`atd` サービスを用いて自動停止／再開を行った。

##### 評価軸

各案について、次の観点で評価した。

- 停止・再開作業の安全性（誤停止や復旧漏れのリスク）
- 再現性・監査性（状態の再現や証跡の残しやすさ）
- 作業工数・自動化のしやすさ

| 評価軸 | 案A：タスク スケジューラの強制停止 | 案B：PowerShell＋タスク スケジューラで状態バックアップ後に停止／再開 |
|---|---|---|
| 停止・再開作業の安全性 | × 個々のタスク状態が追えず、復旧漏れのリスクが高い | ◎ 事前に状態を取得しておくため、元の有効／無効状態に戻しやすい |
| 再現性・監査性 | × 実行履歴やタスク状態の証跡が残りにくい | ◎ XML／CSV による一覧が残り、監査やトレースがしやすい |
| 作業工数・自動化のしやすさ | ○ 一見すると操作はシンプルだが、手作業確認が増えがち | ○ 初期スクリプト作成は必要だが、一度作れば以降は再利用しやすい |

##### 採否

- **案A：タスク スケジューラの強制停止**  
  → **却下**

- **案B：PowerShell＋タスク スケジューラでバックアップ取得後に停止／再開**  
  → **採用**

##### 却下理由

- **案A：タスク スケジューラの強制停止**  
  タスク スケジューラ全体を強制的に停止する方法は、各タスクの有効／無効状態を復元する手がかりが残らず、復旧漏れが発生するリスクが高い。  
  また、一部の停止操作はシステム側で無効化される挙動もあり、実行結果の整合性を担保しにくい。  
  データセンター移行のような影響範囲の広い作業においては、安全性と再現性を優先する必要があると判断し、案Aは採用しないことにした。

### 振り返り

#### 技術的な学び

- Windowsバッチ特有の条件分岐や `errorlevel` の扱いに慣れ、異常終了時の戻り値やログ出力を意識して書くようになった。  
- PowerShell については、AIが生成したスクリプトでも自分で意図と前提条件を読み取り、必要な範囲で修正・コメントを入れてから使う姿勢が身についた。

#### プロセス・コミュニケーションの学び

- データセンター移行のように停止を伴う作業では、影響範囲・ロールバック手順・証跡の取り方を事前に整理して共有しておくことで、関係者の合意が取りやすくなると実感した。  
- 「担当者が手作業で止める手順」ではなく、「誰が実行しても同じ結果になる自動化された手順」に落とし込むことが、運用引継ぎや説明のしやすさにつながると学んだ。