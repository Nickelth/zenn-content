---
title: "CI: RDS Snapshot & Restore Drill（手動バックアップ復元テスト）"
---

## RDS スナップショット復元ドリル CI

### 目的

- 既存の RDS インスタンスから**手動スナップショットを取得**し、  
  そこから**一時インスタンスを復元できることを定期的に確認する**。
- 復元にかかった時間（簡易 RTO）や、エンドポイント・ポート・CA 証明書・パラメータグループが  
  期待どおりかを JSON で記録し、PR として残す。
- 復元後の一時インスタンスは**必ず削除**し、平常時のコストや構成には影響を残さない。

日常のバックアップ設定だけに依存せず、「本当に戻せるか」を CI として形にしている。

### 前提（RDS / IAM / 実行ポリシー）

- 対象となる RDS インスタンスは 1 つに固定している（例: 開発用 `papyrus-pg16-dev`）。
- CI 用 IAM ロールには少なくとも以下の操作が許可されている前提とする。
  - スナップショットの作成・参照・復元・削除
  - DB インスタンスの作成状況の監視
- このワークフローは `workflow_dispatch` の**手動トリガー専用**とし、
  「RDS の復元ドリルを実行してもよいタイミング」で明示的に流す想定とする。
- `concurrency` 設定により、同時に 2 本以上の復元ドリルが走らないようにしている  
  （同じグループで実行中のものがあれば後続をキャンセル）。

### ワークフロー設計

#### トリガーと並列実行

- トリガー: `workflow_dispatch`（手動）
- `concurrency.group = rds-restore-drill` とし、
  - 誤って連続起動された場合も**同時に複数の復元処理が走らない**ようにしている。
  - 実行中に再トリガーされた場合は、古い方をキャンセルして新しい実行を優先。

#### 処理の大きな流れ

1. 対象 RDS から**手動スナップショット**を作成
2. そのスナップショットから、一時インスタンスを**同じサブネットグループ / SG / ParamGroup で復元**
3. 一時インスタンスが利用可能になるまで待機し、  
   エンドポイント・ポート・CA 証明書・復元完了までの秒数・適用パラメータグループを収集
4. 一時インスタンスを削除（`skip-final-snapshot`）
5. 収集した JSON 証跡を `docs/evidence` に追加し、`dev` 向けの PR を自動作成

### 実装ポイント

#### 1. 手動スナップショットの作成

- 対象インスタンス ID に時刻ベースのサフィックスを付けたスナップショット名を採用し、  
  「どのタイミングのドリルで作ったか」が名前から分かる形にしている。
- 作成後は `available` になるまで待機し、その状態を一度取得して証跡として保存している。

#### 2. 一時インスタンスの復元

- 復元に使うネットワーク関連の設定は、**元インスタンスからコピー**している。
  - DB Subnet Group 名
  - VPC Security Group（最初の 1 つ）
  - Parameter Group 名
- 復元時のポイント:
  - パブリックアクセスは無効で復元する。
  - タグは元インスタンスから引き継ぐ設定とし、運用タグがそのまま見えるようにしている。
- 一時インスタンス ID も元インスタンス ID＋サフィックス＋時刻で構成し、  
  「どのスナップショットから復元した一時 DB か」が識別しやすいようにしている。

#### 3. 復元完了後の情報収集

- 一時インスタンスが `available` になるまで待ち、**復元に要した秒数**を計測する。  
  これを簡易的な RTO の目安として JSON に含める。
- 取得している主な情報は次のとおり。
  - 一時インスタンス ID
  - エンドポイント（ドメイン名）は、証跡側ではマスクされた形式で保存
  - ポート番号
  - 復元完了までの秒数
  - 使用されている CA 証明書識別子
  - 適用されたパラメータグループの一覧
- これらは 1 つの JSON にまとめて保存し、  
  「どの条件で復元され、どれくらい時間がかかったか」を後から確認できるようにしている。

#### 4. 一時インスタンスの削除

- 復元ドリルの目的は「戻せることの確認」であり、一時インスタンスを恒久的に残す意図はない。
- CI の終了可否にかかわらず、クリーンアップ処理は `always` で実行し、
  - 一時インスタンスが存在する場合のみ削除
  - 削除完了まで待機
- これにより、ドリルを何度実行しても余計な DB インスタンスが残らない形にしている。

#### 5. 証跡 PR の自動作成

- 収集した JSON 証跡を含むブランチを自動で作成し、  
  `dev` ブランチに対する PR として作成する。
- ブランチ名・PR タイトル・ラベルは「復元ドリルの証跡」であると分かる形式に統一している。
- 面接官・レビュー担当者から見たときに、
  - いつドリルをしたか
  - どのくらいの時間で復元できているか
  - どのような設定で復元されているか
  を PR ベースで追える構成になっている。

### 証跡の扱い

このワークフローが残しているのは、あくまで**メタ情報のみ**であり、  
実データのダンプやスキーマは含めていない。

- 例として、次のような情報だけを JSON にまとめている。
  - スナップショット作成の開始・完了に関するメタ情報
  - 復元に使用したスナップショット ID と一時インスタンス ID
  - 復元完了までの所要時間
  - マスク済みのエンドポイント
  - ポート番号
  - CA 証明書識別子
  - 適用されたパラメータグループの情報

これらを `docs/evidence` 配下に追加し、PR ベースでレビュー・保管する方針としている。

### 失敗例と対策

この CI で想定される失敗パターンと、それに対する基本的な考え方はおおよそ次のとおり。

- **スナップショット作成の失敗**
  - 原因候補: 権限不足、同名スナップショットとの衝突、RDS 側の一時的な制限など。
  - 対策: CI 用 IAM ロールの権限を最小限かつ十分な範囲に保ちつつ、  
    エラー発生時はログから原因を確認して再実行。

- **一時インスタンスの復元失敗**
  - 原因候補: サブネットグループ / セキュリティグループ / パラメータグループの不整合。
  - 対策: 元インスタンスから情報をコピーする実装としているため、  
    これらの設定変更時は CI の実装と合わせて見直す前提。

- **復元待機のタイムアウト**
  - 原因候補: RDS 側の障害や、復元にかかる時間の想定不足。
  - 対策: 所要時間を証跡として蓄積し、  
    将来的に「どこまでを許容するか（運用上の RTO）」を見直す材料にする。

- **PR 作成時のコンフリクト**
  - 原因候補: evidence 用ブランチ命名の重複や、`dev` ブランチの更新タイミング。
  - 対策: タイムスタンプ付きのブランチ名を用い、必要に応じて再実行で吸収する。

### セキュリティと運用上の注意

- 一時インスタンスは**常に非公開（publicly accessible: false）**で復元し、  
  元インスタンスと同じ VPC / サブネットグループ / セキュリティグループを使う。
- 証跡 JSON に出すエンドポイントは、マスク済みのドメインに変換しており、  
  直接アクセスに利用できる情報は残さない。
- CI 用 IAM ロールは、このドリルに必要な RDS 操作に限定する前提とし、  
  本番運用の DB や他リソースへの影響を避ける構成とする。
- 復元ドリルは手動トリガーであり、実行タイミングや頻度は運用ルールで管理する。
