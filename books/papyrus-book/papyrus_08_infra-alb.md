---
title: "IaC: 一時ALB/TG（infra/20-alb）"
---

### 一時 ALB 用 Terraform モジュール（infra/20-alb）

Papyrus の疎通検証で使用する「一時的な ALB / ターゲットグループ」を Terraform で管理するモジュール。  
本番用 ALB とは分離し、**スモークテスト専用の入り口を毎回作って毎回壊す**前提の設計になっている。

#### モジュールの役割

- ECS Fargate 上のタスクに対して、HTTP で疎通確認するための **一時 ALB / ターゲットグループ / リスナー** をまとめて作成する。
- 作られた ALB はスモーク CI から `/healthz` などのエンドポイントにアクセスするためだけに使い、  
  ジョブの最後に Terraform で削除する運用を想定している。
- state はローカルファイル（`/tmp` 配下）に置き、CI 実行ごとに独立した一時環境として扱えるようにしている。

#### 管理しているリソース

このモジュールでは、ALB 周辺だけを次の単位で IaC 化している。

- **ALB 用セキュリティグループ**
  - VPC 単位で 1 つ作成する。
  - インバウンドは HTTP(80) のみ許可し、許可元 CIDR は変数で切り替え可能。
  - デフォルトでは `0.0.0.0/0` を許可するが、実際の利用時は CI 側で適切な CIDR を渡す前提になっている。
  - アウトバウンドは全トラフィック許可。

- **Application Load Balancer 本体**
  - タイプは Application Load Balancer。
  - サブネットはパブリックサブネットのリストを入力で受け取り、そのまま ALB の配置先として使用する。
  - セキュリティグループには、上記の ALB 用 SG を紐づける。
  - アイドルタイムアウトは 30 秒、削除保護は無効。

- **ターゲットグループ**
  - タイプは HTTP / `ip` ターゲット。
  - ポート番号はコンテナポートを変数として受け取り、デフォルトは 5000。
  - ディレジストレーションの遅延時間は 15 秒。
  - ヘルスチェックは `/healthz` を対象とし、HTTP 200–399 を正常とみなす。
    - 間隔は 10 秒、タイムアウト 5 秒、しきい値は 2 回連続で healthy / unhealthy。

- **HTTP リスナー**
  - ポート 80 / HTTP のリスナーを 1 つ作成し、デフォルトアクションとして上記ターゲットグループにフォワードする。

- **一意なサフィックス用の ID**
  - `random_id` リソースでバイト列を生成し、ALB 名・ターゲットグループ名・セキュリティグループ名に付与する。
  - ALB / ターゲットグループ名の一意制約と、連続実行時の名前衝突を避ける目的。

#### 入力パラメータの考え方

モジュールが受け取る主な入力は次の通り。

- `vpc_id`  
  ALB とターゲットグループを配置する VPC の ID。

- `public_subnet_ids`  
  ALB を配置するパブリックサブネットの ID 一覧。  
  AZ をまたいだリストを渡すことを想定している。

- `container_port`  
  ECS タスク側のコンテナが待ち受けているポート番号。  
  デフォルトは 5000 だが、アプリケーション側のポート設計に合わせて変更できる。

- `allow_cidrs`  
  ALB のセキュリティグループで許可する送信元 CIDR のリスト。  
  デフォルト値は `["0.0.0.0/0"]` だが、検証環境の要件に応じて絞り込むことを前提としている。

- `ecs_tasks_sg_id`  
  ECS タスク用セキュリティグループの ID を受け取る変数。  
  現状の `main.tf` では参照しておらず、**ALB 側のセキュリティグループのみを Terraform で管理する形**になっている  
  （タスク SG への許可ルールは、CI 側の別ステップで制御している）。

#### 設計上のポイント

- **state の扱い**  
  - backend を `local` にしておき、state ファイルの保存先を `/tmp` に固定している。  
  - これにより、スモークテスト CI から一時的に `terraform apply` / `destroy` を実行しても、  
    既存の Terraform プロジェクトやリモートバックエンドと干渉しない構成になる。

- **一時リソース前提のチューニング**
  - 削除保護を無効化しており、`destroy` でそのまま削除できる前提の設定にしている。
  - タイムアウトやヘルスチェック間隔は、長期運用ではなく「短時間の疎通検証」に向いた値に寄せている。

- **ALB 名・ターゲットグループ名の衝突回避**
  - ALB とターゲットグループにはユニークな名前制約があるため、`random_id` のサフィックスで毎回異なる名前を付与している。
  - これにより、CI を連続実行した場合でも名前重複エラーが発生しないようにしている。

- **ターゲット登録はあえて Terraform 外に出している**
  - このモジュールはターゲットグループまでを Terraform 管理の対象とし、  
    実際の ECS タスクの IP 登録や AZ チェックなどは、別の CI ワークフロー（ALB スモーク）側で制御している。
  - ALB / ターゲットグループそのものは IaC、ターゲットの動的な紐付けはスクリプトという分担になっている。