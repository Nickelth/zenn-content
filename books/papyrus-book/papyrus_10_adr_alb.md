---
title: "ADR: 一時ALBスモーク vs 恒久ALB"
---

**Status**: Accepted  
**Date**: 2025-10-31 JST  
**Owner**: Papyrus Invoice（ECS/Fargate + RDS）

## 背景 / Context

Papyrus Invoice は、ECS Fargate 上のタスクから RDS に接続するシンプルな構成を前提としているが、  
インフラ全体としては次のような要件があった。

- アプリケーションの `/healthz` `/dbcheck` を、インターネット側からの外形監視に近い形で確認したい
- 疎通結果やログを、CI の一部として証跡として残したい
- 一方で、まだ本番トラフィックをさばくフェーズではなく、恒久的なインターネット公開用 ALB を常時起動しておくコストや運用負荷は避けたい

このため、「ECS サービスに対してどのように ALB を配置し、どの単位を恒久リソースとし、どこを一時リソースとするか」を決める必要があった。

## 決定 / Decision

Papyrus Invoice では、次の方針とした。

- 恒久的な公開用 ALB はまだ作成しない
- 代わりに、スモークテスト専用の ALB / ターゲットグループ / セキュリティグループを Terraform で一時的に作成し、CI（ALB Smoke ワークフロー）内で `/healthz` `/dbcheck` の疎通確認を行う
- スモークテスト完了後は、Terraform destroy で必ず削除する運用とし、ネットワークルールの開閉も CI 内で完結させる

つまり、ALBは「常設の入り口」ではなく、「CIから呼び出す検査用の道具」という扱いにしている。

## 代替案 / Alternatives

検討した主な案は次の通り。

### 案A: 恒久ALBを先に構築する

- 内容  
  - 本番用を想定した ALB を 1 台作成し、常に ECS サービスに向けて公開しておく  
  - スモークテストも、その恒久 ALB を経由して実施する

- メリット  
  - URL が固定されるため、利用者向けのエンドポイントと疎通確認用エンドポイントを兼ねられる  
  - ALB に対する監視・ログ設計を一度決めれば、そのまま本番運用に引き継げる

- デメリット  
  - 本番トラフィックがまだ存在しない段階から、ALB 分のコストが常に発生する  
  - WAF やカスタムドメインなど、周辺設定を先行で考える必要が出てくる

### 案B: ローカルまたは CloudShell から直接 curl する

- 内容  
  - CloudShell や開発端末から、ECS タスクの ENI / IP へ直接 curl して疎通を確認する  
  - もしくはポートフォワードなどを使い、ALB 自体を経由しない検証に限定する

- メリット  
  - ALB を作成しないため、コストも構成も最小限で済む  
  - ネットワークレベルの検証としてはシンプル

- デメリット  
  - 実際の運用で利用される「ALB 経由のパス」を検証できない  
  - DNS / セキュリティグループ / ターゲットグループなど、ALB まわりの設計ミスを検知しづらい  
  - CI からの再現性ある検証・証跡化がしにくい

### 案C: VPC Lattice / API Gateway / CloudFront など別終端を採用

- 内容  
  - L7 終端を ALB 以外のマネージドサービスに寄せ、そちらを経由して `/healthz` を確認する

- メリット  
  - 将来的にマイクロサービス化した場合の拡張性が高い  
  - 認証やルーティング機能をあわせて利用できる

- デメリット  
  - 現時点の Papyrus Invoice の規模に対しては過剰な構成になる  
  - 学習コスト・運用コストが増え、PoC フェーズとしてのシンプルさを損ねる

## 影響 / Consequences

### Pros（採用による利点）

1. **コストを必要なタイミングにだけ発生させられる**  
   一時 ALB は CI 実行時だけ起動し、destroy で確実に削除する運用とすることで、  
   恒久 ALB を常時動かすよりもコストを抑えられる。

2. **ALB 経由の疎通・配線ミスを CI で検知できる**  
   一時 ALB でも、ターゲットグループやセキュリティグループの設定は本番と同じ考え方になる。  
   そのため、「ALB は立っているがターゲットが `unused`」「SG の向きが間違っている」といった問題を、  
   スモークテストの段階で検知できる。

3. **証跡を CI 単位で整理できる**  
   Terraform の plan/apply/destroy ログ、ALB 経由の `/healthz` `/dbcheck` のレスポンス、  
   CloudWatch Logs の一部を CI がブランチとしてまとめる設計とし、  
   インフラ変更と疎通検証を一連の証跡として残せる。

### Cons（採用による負債・注意点）

1. **CI と Terraform の構成が複雑になる**  
   一時 ALB を apply / destroy するための Terraform モジュールと、  
   ターゲット登録や SG 開閉を行う CI スクリプトが必要になる。

2. **恒久 ALB を立てたときに構成を整理し直す必要がある**  
   将来的に恒久 ALB を採用する際には、  
   一時 ALB 用モジュールと役割が重なる部分をどう統合するかを再検討することになる。

3. **スモークテストの実行時間が若干伸びる**  
   ALB / ターゲットグループ作成、ヘルスチェックの安定化、destroy までを含めるため、  
   ローカルからの直接 curl と比べると CI の実行時間は長くなる。

## 記録 / Decision Record

- **Date**: 2025-10-25 JST  
- **Owner**: Papyrus Invoice（ECS/Fargate + RDS）  
- **Scope**:  
  - ALB / ターゲットグループ / ALB 用セキュリティグループを、一時リソースとして扱う方針  
  - Papyrus Smoke CI（ALB スモークテスト）の設計  
  - `infra/20-alb` Terraform モジュールの責務

## フォローアップ / Follow-ups

一時 ALB 方式は、PoC〜検証フェーズでは適しているが、  
将来的に次の条件を満たした場合は、**恒久 ALB への移行**を検討する。

- ユーザー向けの恒久的な HTTP エンドポイントが必要になった  
  （例: 外部システムからのコールバックや、社内向けポータルとしての公開など）
- オンラインでのトラフィック量が増え、ALB に対する監視・メトリクスを  
  CI ではなく運用監視の中心として扱いたい段階になった
- WAF・カスタムドメイン・証明書管理など、ALB を軸にした周辺機能を本格的に使い始める

このときは、

- 現在の一時 ALB モジュールのうち「恒久化してよい部分」（例: SG のポリシー、リスナー設定）と、  
- CI から呼び出すために分離しておく部分

を整理し直し、恒久 ALB 用のモジュールとスモークテスト用の仕組みを再構成する想定とする。