---
title: "CI: ECS Deploy（タスク定義更新とタスク数制御）"
---

## ECSタスク数とイメージ切り替えを CI から制御する

### 目的

- 手動トリガー（workflow_dispatch）で、指定した **コンテナイメージのタグ** を ECS サービスに反映する。
- 入力値としてタスク数（DesiredCount）を受け取り、**「どのイメージを何台起動するか」を CI から直接制御**できるようにする。
- ECS のローリングデプロイ機能を使い、**ロールバックしやすいシンプルなデプロイパターン**に統一する。
- 起動用のワークフロー（本 CI）と、停止専用のワークフロー（ECS Scale）を分けることで、
  「新イメージの反映」と「検証環境のオン／オフ」を明確に分離している。

### 前提（クラスター / サービス）

- あらかじめ以下が用意されていることを前提としている。
  - Fargate 用の ECS クラスター
  - 対象アプリケーションの ECS サービス
  - サービスが参照するタスク定義ファミリーとコンテナ名
- サービスのデプロイ方式（ローリング時の最小台数・最大台数など）は、ECS 側の設定で管理しておき、  
  CI からは「使用するイメージタグ」と「DesiredCount だけ」を操作対象にしている。

### ワークフロー設計

#### トリガーと入力

- 手動実行専用のワークフロー（workflow_dispatch）として設計している。
- 実行時の入力項目：
  - **イメージタグ**：ECR に登録済みのタグ（例：commit SHA ベースのタグなど）
  - **DesiredCount**：デプロイ後に維持したいタスク数（デフォルトは 1）
- これにより、「どのバージョンを何台まで増やすか」をデプロイ単位で明示的に選べる。

#### タスク定義の更新戦略（イメージタグ差し替え）

- ベースとなるタスク定義は、**ECS 上に登録されている最新版をそのまま取得**し、それをテンプレートとして扱う。
- 取得したタスク定義のうち、対象コンテナのイメージだけを「指定されたタグ付きのイメージ」に差し替え、新しいリビジョンとして登録する。
- タスク定義の細かいパラメータ（CPU・メモリ・環境変数など）は ECS / IaC 側で管理し、  
  CI からは「どのイメージタグを使うか」を切り替えるだけにしている。
  → 環境ごとの差分があっても、CI が壊れにくい設計。

#### Preflight チェック（対象の存在確認）

- クラスター名・サービス名・タスク定義ファミリー名が正しく存在するかを、デプロイ前に確認している。
- 存在しない場合や、想定していない状態の場合は、その時点で CI を失敗させることで、  
  「名前のタイプミスや対象間違い」でよく分からないエラーになるのを避けている。

#### force-new-deployment と安定化待ち

- 新しいタスク定義リビジョンをサービスに適用する際は、ECS の「新しいデプロイを強制する」オプションを有効にしている。
- これにより、サービスは設定済みのデプロイポリシー（min/max percent）に従って、  
  旧タスクから新タスクにローリングで入れ替わる。
- CI 側では「サービスが安定した状態に戻るまで待つ」設定にしており、  
  リクエストがすぐ捌ける状態になるまでを含めてデプロイ完了とみなす。

### 実装ポイント

#### 失敗時のロールバック方針

- ロールバックは「**以前のイメージタグ、または以前のタスク定義リビジョンに戻す**」のが基本方針。
  - CI を再実行し、直前に使っていたタグを再度指定してデプロイする。
  - もしくは、ECS 側で過去のタスク定義リビジョンを選び直す。
- どのタグ・どのリビジョンをいつ使ったかは、コミットログやデプロイ履歴と紐付けて管理する想定。

#### タスク定義リビジョンのバージョニング

- すべてのデプロイは「タスク定義ファミリーの新しいリビジョン」として記録される。
- CI は毎回「最新リビジョンをベースに、コンテナイメージだけ差し替えて新リビジョンを登録する」動きになる。
- 設定の微修正も含めて履歴を追いやすく、  
  「どのデプロイでどんな設定・どのイメージが使われていたか」を ECS 側からたどれる構成。

### 典型的な失敗パターンと対策

- **タスクが起動直後に落ち続ける（STOPPED 連発）**
  - よくある原因：
    - シークレットや環境変数のキー名を変えたが、アプリ側が追従できていない。
    - セキュリティグループの誤設定で、DB などのバックエンドに到達できない。
    - 指定したイメージタグが ECR に存在しない。
  - 対応方針：
    - デプロイ後はコンテナの起動ログを確認し、エラー内容から原因を特定する。
    - タグの運用は、ビルド CI で付与したものと揃える（コミット SHA ベースなど）ように統一する。

- **クラスター / サービスの設定ミス**
  - 想定外のクラスターやサービスを指していると、デプロイ先自体が間違う可能性がある。
  - そのため、対象名はリポジトリ変数で固定し、変更時はレビュー必須にしている。

### セキュリティ上の配慮

- **Execution Role**
  - コンテナ実行環境が持つロール（Execution Role）は、
    - コンテナイメージの取得
    - ログ出力
    - シークレットの取得
    といった「タスク起動時に必要な最低限の権限」のみに絞っている。

- **Task Role**
  - アプリケーションが実行中に外部サービスへアクセスする際に使うロール（Task Role）は別に分け、
    - 構成情報の読み取り（パラメータストアなど）
    といった実行時権限だけを持たせている。

- **CI 用ロールとの分離**
  - CI が Assume するロールは、
    - タスク定義の更新
    - サービスへの適用
  といった「デプロイ操作」に必要な権限のみに限定し、  
  アプリケーション実行時に使うロールとは完全に分離している。
  - これにより、「デプロイできる人」と「本番リクエストの権限で何かできる人」を明確に分けている。