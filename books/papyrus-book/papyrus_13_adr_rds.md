---
title: "ADR: RDS は当面 Single-AZ とする"
---

**Status**: Accepted  
**Date**: 2025-12-01 JST  
**Owner**: Papyrus Invoice（ECS/Fargate + RDS）  
**Tags**: RDS, Single-AZ, Recovery, Evidence

### 背景 / Context

- 本システムは個人ポートフォリオ用途であり、24時間365日の高可用は必須要件ではない。
- 一方で、**「インシデント発生時にどのように復旧するか」** を具体的に示すことは、採用・面接の場でインフラ設計力を説明するうえで重要。
- RDS の構成を Multi-AZ / Aurora などにすると、ポートフォリオとしてはランニングコストが高くなり、実運用のスケールとも乖離してしまう。
- そこで、RDS 自体は Single-AZ にとどめつつ、GitHub Actions で **スナップショットからの復旧ドリル（CI）をコード化** し、定期的に実行・証跡を残す方針を検討した。

### 決定 / Decision

- RDS は **Single-AZ 構成** とし、以下の運用を組み合わせる。
  - 自動バックアップおよび PITR（Point-In-Time Recovery）を有効化する。
  - GitHub Actions にて、RDS の手動スナップショットからの復旧ドリルを実施するワークフローを実装する。
    - `workflow_dispatch` トリガーで必要なタイミング（月次想定）で実行。
    - 手順はすべて CI 上のシェルスクリプトとして定義し、人手に依存しない。
- 復旧ドリルの内容を次のように固定し、**ポートフォリオとして説明しやすいテストケース** とする。
  1. 対象インスタンス `papyrus-pg16-dev` の手動スナップショットを作成。
  2. 当該スナップショットから、一時インスタンス `papyrus-pg16-dev-restore-<UTCタイムスタンプ>` を作成。
  3. `db-instance-available` までの経過秒数を計測し、RTO の参考値として記録。
  4. 復旧したインスタンスのエンドポイント・ポート・CA 証明書 ID・適用パラメータグループを取得。
  5. 一時インスタンスを削除し、DR ドリルによるリソース増加を残さない。
- 各実行で得られた JSON を `docs/evidence` 配下に保存し、CI が自動的に evidence ブランチ＋PR（ラベル `evidence`, `automation`）を作成する。
  - 面接時には、この PR と JSON を提示することで、「復旧手順」と「実際に動いた証拠」をセットで示せる。

### 代替案 / Alternatives

1. **RDS Multi-AZ / Aurora を採用する**
   - 利点
     - ゾーン障害時でも自動フェイルオーバーによりダウンタイムが短くなる。
     - アプリ側から見ると復旧手順がシンプル。
   - 欠点
     - 個人ポートフォリオとしてはランニングコストが高く、現実的ではない。
     - 「障害復旧手順」を自分で設計・実装した実績として説明しづらい。

2. **バックアップのみ有効化し、復旧ドリルは手動手順書ベース**
   - 利点
     - CI 実装なしで、最小限の構成で済む。
   - 欠点
     - 実際に復旧できるか毎回人手で検証する必要があり、再現性が低い。
     - 採用担当者に対して、「コードとして復旧手順を管理している」ことを示しづらい。

3. **バックアップも復旧ドリルも行わない（開発 DB と割り切る）**
   - 利点
     - 最小コスト・最小構成。
   - 欠点
     - インフラ設計・運用の観点から得られるアピールポイントがほぼ無い。
     - RDS を使う意味（マネージドなバックアップや復旧機能の活用）を示せない。

### 影響 / Consequences

**メリット**

- インフラコストを抑えつつ、「障害発生時にどのように復旧させるか」を具体的な CI として提示できる。
- 復旧手順が GitHub Actions + AWS CLI のコードとして残るため、**再現性の高い DR ドリル** になっている。
- `docs/evidence` 配下の JSON と evidence PR を見れば、
  - どのくらいの時間で復旧しているか（RTO の実測値）
  - どの CA / パラメータグループで立ち上がっているか  
  を第三者（採用・面接担当者）が確認できる。
- 採用の場では、次のような説明がしやすい。
  - 「Multi-AZ ではなく Single-AZ を選択したコスト・要件上の理由」
  - 「そのうえで、具体的な DR プロセスを CI と Evidence で補完している」という設計判断。

**デメリット / トレードオフ**

- 実サービスとして運用する場合、Single-AZ であるため AZ 障害時のダウンタイムは長くなりうる。
- 復旧は「別インスタンスを立ち上げる」前提のため、アプリ側でエンドポイント差し替えなどの運用作業が必要になる。
- CI はあくまで「単一インスタンスのスナップショットからの復旧」を検証するものであり、
  - クロスリージョン DR
  - KMS キーの切り替え
  - 大量接続時の挙動  
  などは別途設計・検証が必要。

### 記録（Decision Record）

- DR ドリル CI
  - GitHub Actions ワークフロー: RDS Snapshot & Restore Drill  
    （リポジトリ直下 `.github/workflows/` 配下に配置）
  - 実行トリガー: `workflow_dispatch`（手動実行）

- 監視・アラート
  - RDS / アプリ関連のアラーム定義: `infra/30-monitor`（Terraform モジュール）

- CI による実際の証跡（2025-12-01 実行分の例）
  - `docs/evidence/20251201_075653_rds_snapshot_start.json`  
    - 手動スナップショット作成リクエストのレスポンス
  - `docs/evidence/20251201_075929_rds_snapshot_facts.json`  
    - 作成されたスナップショットの詳細情報
  - `docs/evidence/20251201_075934_rds_restore_start.json`  
    - 一時インスタンス復元リクエストのレスポンス
  - `docs/evidence/20251201_080815_rds_pg_applied.json`  
    - 一時インスタンスに適用されたパラメータグループ情報
  - `docs/evidence/20251201_080815_rds_restore_facts.json`  
    - 一時インスタンスのエンドポイント・ポート・CA 証明書 ID・RTO 秒数
  - `docs/evidence/20251201_080816_rds_restore_delete.json`  
    - 一時インスタンス削除リクエストのレスポンス