---
title: "ADR: 観測の入口（1行JSON＋HTTP生ログ＋監査分離）"
---

**Status**: Accepted  
**Date**: 2025-11-05 JST  
**Owner**: Papyrus Invoice（ECS/Fargate + RDS）  
**Tags**: Observability, Logging, CloudWatch, CloudTrail, Evidence

## 背景 / Context

Papyrus Invoice では、インフラとアプリのふるまいを「それなりに追える」レベルにはしておきたい一方で、  
CI の実行時間や PR 上のノイズは増やしたくない。

具体的には次のような要件がある。

- ALB 経由の `/healthz` `/dbcheck` を、**CI から自動で叩いて疎通確認したい**
- その結果やログを、**人間が読める証跡として PR に残したい**
- 一方で、CloudTrail / Config のような監査向けデータは
  - 量が多くなりがちで、
  - 機微な情報も含み、
  - 毎回のスモークテストに混ぜるには重い

このため、「日常的なスモークテストで見るべき観測データ」と  
「監査や追跡のために必要な生データ」を分けて扱う方針を決める必要があった。

## 決定 / Decision

Papyrus Invoice では、観測の入口を次の 3 つのレイヤに分けることにした。

1. **CloudWatch Logs の 1 行 JSON（構造化ログ）**  
   - アプリ側で、ルート名などを含む JSON ログを 1 行単位で出力する設計とする。  
   - スモークCI（ALB Smoke）では、`filter-log-events` を用いて `/healthz` `/dbcheck` に対応するログを検索し、  
     「該当ルートの JSON ログが出ているか」を確認する。  
   - 現時点では JSON ログの整備が途中であり、配列が空になるケースもあるが、  
     「構造化ログを CloudWatch に集約し、CI から最小限だけ拾う」という方針は維持する。

2. **HTTP 生ログ（ALB 経由の curl レスポンス）**  
   - 一時 ALB を経由して `/healthz` `/dbcheck` に対して curl を実行し、  
     ステータスコードとレスポンスを証跡として保存する。  
   - これは「ALB 配線と ECS タスクが正しく動いているか」という疎通の確認が主目的であり、  
     詳細なアプリの挙動分析は CloudWatch の JSON ログに任せる。

3. **監査系ワークフロー（CloudTrail / Config 24h）は別 CI に分離**  
   - 操作履歴や設定スナップショットが必要な場合は、  
     専用の CI（CloudTrail & Config 24h）を手動トリガーで実行し、  
     直近 24 時間分をまとめて PR にする。  
   - スモーク CI には CloudTrail / Config を含めず、  
     通常のデプロイや疎通確認と監査用途を分離して扱う。

この結果、日常的なスモークテストでは「HTTP 生ログ＋必要最低限の JSON ログ確認」だけを扱い、  
監査寄りの情報は別ワークフローに逃がす構成とした。

## 代替案 / Alternatives

### 案A: すべてをスモーク CI に統合する

- 内容  
  - ALB スモーク CI の中で CloudTrail / Config もあわせて取得し、  
    毎回の実行で HTTP 生ログ・CloudWatch ログ・CloudTrail / Config をすべて PR に含める。

- 不採用理由  
  - CloudTrail / Config はデータ量が多く、CI の実行時間とログ量を押し上げる。  
  - 監査色の強い情報が、デプロイや疎通確認の PR に混在し、レビューしづらくなる。  
  - 「とりあえずスモークを回したい」場面で常に重い処理を踏むことになる。

### 案B: CloudTrail / Config のみを証跡とし、JSON ログや HTTP 生ログを持たない

- 内容  
  - 操作履歴（CloudTrail）と設定スナップショット（Config）のみを監査証跡として扱い、  
    HTTP 生ログやアプリケーションログは CI から参照しない。

- 不採用理由  
  - CloudTrail / Config は「何を変更したか」は追えるが、  
    `/healthz` `/dbcheck` が実際に 200 を返しているか、といった動作レベルの情報は分からない。  
  - レスポンスやルート単位のログが無い状態では、  
    デプロイ後の挙動確認に時間がかかる。

### 案C: HTTP 生ログのみを残し、CloudWatch 側の JSON ログを見ない

- 内容  
  - ALB 経由の curl 応答だけを証跡とし、CloudWatch Logs の構造化ログは観測設計の対象に含めない。

- 不採用理由  
  - HTTP レスポンスだけでは、内部処理のパスや失敗箇所が把握しづらい。  
  - 将来的にメトリクス集約や検索を行う際、JSON ログが無いと拡張性が低い。  
  - 「アプリ側のログを 1 行 JSON に寄せる」という方向性は、のちの SLO 設計やトレース連携でも活きる。

## 影響 / Consequences

### メリット

1. **読める証跡を最小限で揃えられる**  
   - スモーク CI では、HTTP 生ログと、ルート単位の JSON ログの存在確認に絞ることで、  
     PR に載る証跡の量を抑えつつ、「本当に動いているか」を判断しやすくしている。

2. **監査向けの重いデータを日常運用から切り離せる**  
   - CloudTrail / Config は専用の CI から必要なときだけ取得するため、  
     通常のデプロイや疎通確認のワークフローが肥大化しない。  
   - 監査が必要になったタイミングで、24 時間分の履歴をまとめて PR として扱える。

3. **将来の拡張先を確保しやすい**  
   - CloudWatch に 1 行 JSON を集約する方針を取っているため、  
     後からメトリクス化や検索を強化する余地が残る。  
   - HTTP 生ログと組み合わせることで、「いつどのエンドポイントを叩いたか」を追いやすい構成になっている。

### デメリット・注意点

1. **観測ポイントが複数のワークフローに分散する**  
   - スモーク CI と監査 CI の両方を見ないと全体像が掴めない場面がある。  
   - レビュアーが「どの PR でどこまでの証跡が揃っているか」を理解する必要がある。

2. **JSON ログ側はまだ整備途中である**  
   - 現状、CloudWatch から取得した配列の中身が空になるケースがあり、  
     「JSON ログが必ず 1 行取れる」とは限らない。  
   - アプリ側のロガー整備とあわせて、今後改善が必要になる。

3. **監査 CI は手動トリガーのため、実行されない期間がありうる**  
   - CloudTrail / Config の 24 時間スナップショットは、  
     明示的に CI を実行しない限り PR に残らない。  
   - 監査観点でどの頻度が妥当かは、別途運用ルールとして決めていく必要がある。

## 記録 / Decision Record

- **Date**: 2025-11-05 JST  
- **Owner**: Papyrus Invoice（ECS/Fargate + RDS）  
- **Scope**:  
  - スモーク CI（ALB 経由疎通確認）の証跡設計  
  - CloudWatch Logs / HTTP 生ログ / CloudTrail / Config の役割分担  
  - `docs/evidence` 以下に保存するファイルの方針

## フォローアップ / Follow-ups

今後、観測レイヤを段階的に強化する余地がある。

- **SSL 証明書検証の明示化**  
  - 現状、DB 接続は `PGSSLMODE=require` のみ設定している。  
  - 将来的には `sslrootcert` の検証や、証明書チェーンの取り扱いも含めて、  
    TLS 周りの設定とログ出力を整理する。

- **p90 アラームから SLO 設計へ**  
  - ALB の p90 アラームは定義しているが、  
    まだ SLO やエラーバジェットといったかたちには落とし込んでいない。  
  - どのレイテンシ水準を「目標」と見なすかを決め、それに対するアラームの位置づけを再整理する。

- **分散トレースの導入検討**  
  - 現在は CloudWatch Logs と HTTP 生ログが中心であり、  
    リクエスト単位のトレース ID 連携までは行っていない。  
  - 必要になった段階で、ALB → ECS → RDS という経路をまたいだトレースを  
    どのレイヤに導入するかを検討する。