---
title: "IaC: CloudWatch Alarm（infra/30-monitor）"
---

## CloudWatch アラーム用 Terraform モジュール（infra/30-monitor）

Papyrus の運用監視で使用する CloudWatch アラームを Terraform で管理するモジュールである。  
ECS サービスと ALB の状態を継続的に監視し、しきい値を超えた場合に SNS 経由で通知できるようにしている。

### モジュールの役割

このモジュールは、次の 2 点を目的としている。

- ECS / ALB に関する基本的な監視指標を、コードとして一括管理すること  
- しきい値や対象リソース（クラスター名・サービス名・ALB / ターゲットグループ）を変数で切り替えられるようにし、環境ごとの差分を管理しやすくすること

CloudWatch アラームの設定を手作業ではなく Terraform で定義することで、
同じ監視ルールを他の環境にも再利用しやすくしている。

### 管理しているリソース

このモジュールで Terraform 管理しているのは、SNS トピックと 3 種類の CloudWatch アラームである。

- **SNS トピック**
  - 監視通知の送信先となる SNS トピックを 1 つ作成する。
  - 実際の通知先（メールアドレスや外部連携用エンドポイントなど）は、このトピックに対するサブスクリプションとして別途追加する前提の設計になっている。

- **アラーム 1: ECS メモリ使用率**
  - 対象メトリクス:
    - 名前空間: `AWS/ECS`
    - メトリクス名: `MemoryUtilization`
    - 統計: `Average`（平均値）
  - 対象リソースは、クラスター名とサービス名の組み合わせで特定する。
  - 5 分間隔のデータを 2 期間連続で評価し、平均値が 80% を超えた場合にアラームと判定する。
  - データが欠損している場合は「問題がある」とみなす設定になっている。

- **アラーム 2: ALB の 5xx エラー**
  - 対象メトリクス:
    - 名前空間: `AWS/ApplicationELB`
    - メトリクス名: `HTTPCode_ELB_5XX_Count`
    - 統計: `Sum`（合計）
  - 対象の ALB は、`LoadBalancer` 次元に ALB の ARN のサフィックス（`arn_suffix`）を渡す形で特定する。
  - 5 分間隔のデータを 2 期間連続で見て、5xx 応答の合計が 1 を超えた場合にアラームと判定する。
  - データが無い場合は「問題なし」とみなす設定になっている。

- **アラーム 3: ALB レイテンシ（p90）**
  - 対象メトリクス:
    - 名前空間: `AWS/ApplicationELB`
    - メトリクス名: `TargetResponseTime`
    - 統計: `p90`（90 パーセンタイル）
  - 対象リソースは、ALB とターゲットグループの両方の ARN サフィックスを次元として渡すことで特定する。
  - 5 分間隔のデータを 2 期間連続で評価し、p90 が 1.5 秒を超えた場合にアラームと判定する。
  - こちらも、データが無い場合は「問題なし」とみなす設定である。

いずれのアラームも、アラーム発生時と復旧時（OK 状態）の両方で、
同じ SNS トピックに通知するよう定義している。

### 入力パラメータの考え方

モジュールが外部から受け取る主な値は次の通りである。

- 監視対象を配置している AWS リージョン
- SNS トピック名
- ECS クラスター名 / サービス名
- ALB の ARN サフィックス
- ターゲットグループの ARN サフィックス

リージョンやリソース名は環境ごとに異なるため、Terraform の変数として受け取り、同じモジュールを複数環境に流用できるようにしている。

### 設計上のポイント

- **SNS トピックを 1 箇所にまとめる構成**  
  すべてのアラームで共通の SNS トピックを参照するようにしている。  
  通知ルールの追加・変更は SNS 側に集約されるため、Terraform のコードを変更せずに通知先を差し替えられる。

- **ALB / ターゲットグループの指定方法**  
  ALB 関連のメトリクスは、CloudWatch 上では ARN 全体ではなく「ARN のサフィックス」を次元として指定する必要がある。そのため、ALB とターゲットグループの arn_suffix を変数で受け取り、アラームの dimensions に設定している。

- **評価期間としきい値の考え方**  
  すべてのアラームで 5 分間隔のデータを 2 期間連続で評価しており、「一時的なスパイク」ではなく「一定時間続く異常」を検知する設定になっている。  
  しきい値（メモリ 80%、5xx > 1、p90 > 1.5 秒）は、Papyrus の検証環境で扱う規模感を前提にした値であり、本番環境に合わせて調整できるよう、コードとして残している。

- **missing data の扱い**
  ECS メモリのアラームでは、データ欠損を「問題あり」とみなす一方で、ALB 関連のアラームでは「問題なし」とみなす設定にしている。  
  これにより、ECS 側の計測が止まっている場合は検知しつつ、ALB のトラフィックが一時的に途切れただけのケースは不要なアラームが出ないようにしている。