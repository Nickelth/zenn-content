---
title: "CI: ALB Smoke（一時ALB/TGによる疎通検証）"
---

## 一時 ALB を使った外形スモークテスト

### 目的

- 既存の ECS Fargate + RDS 構成に対して、検証専用の一時 ALB / ターゲットグループを作成し、  
  アプリのヘルスチェック用エンドポイント（例：`/healthz` `/dbcheck`）を外形から確認する。
- RDS 接続設定やシークレットの不整合、ALB / ターゲットグループ / セキュリティグループ / リスナー周りの配線ミスを、  
  デプロイ前に自動で検知し、その結果を証跡としてリポジトリに残す。

### 前提（ネットワーク構成とアプリ側）

- VPC / パブリックサブネット / プライベートサブネット / ECS サービス / RDS は既に構築済み。
- ALB 用の Terraform コードは、アプリや他のリソースとは分けて管理しており、  
  「検証用の ALB / ターゲットグループ / ALB 用セキュリティグループ」だけを作るモジュールになっている。
- ECS タスク用のセキュリティグループは既存のものを流用し、その ID を CI から注入する前提。
- アプリケーション側には、疎通確認用エンドポイントを実装済み：
  - `/healthz` … アプリが立ち上がっているか
  - `/dbcheck` … RDS への接続が成功するか

### 設計の要点

#### 1. Preflight：アプリルートの静的チェック

- CI の最初にアプリをテスト向けに起動し、ルーティング定義からエンドポイント一覧を取得する。
- `/healthz` と `/dbcheck` が存在しなければ、その時点で CI を失敗させる。
- これにより、「インフラをいじる前に、そもそもアプリ側が必要なルートを持っているか」をチェックしている。

#### 2. DB 接続情報と RDS 実体のドリフト検知

- DB 接続情報（シークレットなど）に設定されているホスト名・ポートと、  
  実際の RDS インスタンスのエンドポイント・ポートを比較する。
- 値に差異があれば「構成ドリフト」と判断し、疎通検証に進む前に CI を中断する。
- これにより、「シークレットだけ更新して RDS 側を変更していない」といったズレを早期に検知できる。

#### 3. 一時 ALB / ターゲットグループの生成と確実な破棄

- CI 実行時にだけ有効なパラメータ（VPC / サブネット / コンテナポートなど）を元に、一時 ALB / ターゲットグループ / ALB 用セキュリティグループを Terraform で作成する。
- ジョブの最後に、成功・失敗にかかわらず必ず Terraform で削除するようにしており、検証用の ALB が残り続けないようにしている。
- 本番用 ALB には一切触れず、検証専用の ALB を毎回作って毎回壊す、という設計。

#### 4. セキュリティグループの自動開閉

- 実際に動いている ECS タスクから ENI やセキュリティグループを動的に取得し、  
  一時 ALB のセキュリティグループからタスクのセキュリティグループへの通信（アプリのポート）を一時的に許可する。
- 既に同じルールが存在する場合は警告ログにとどめ、エラーにはしない。
- ジョブ終了時には、付与した許可ルールを必ず削除し、「検証のために開けた穴」は CI 内で閉じるようにしている。

#### 5. リスナー設定の冪等性（既存との競合対策）

- HTTP:80 のリスナーが存在しなければ作成し、既に存在する場合は現在の設定を取得してから、  
  デフォルトの転送先が今回の一時ターゲットグループになるように更新する。
- 既に同じポートのリスナーがある場合のエラーも考慮し、  
  「余計なリスナーを増やさず、既存の設定を上書きする」形で冪等に制御している。

#### 6. AZ ミスマッチ検知（`unused` 状態の事前防止）

- ALB が有効になっているアベイラビリティゾーンと、ECS タスクが実際に動いているゾーンを比較する。
- タスク側のゾーンが ALB 側に有効化されていない場合は、ターゲットの状態が `unused` になり得るため、その時点で CI を失敗させる。
- これにより、AZ 設定の食い違いによる「ターゲットが一生ヘルシーにならない」パターンを事前に防ぐ。

#### 7. ターゲットのヘルスチェック待ち

- 作成したターゲットグループに ECS タスクの IP を登録したあと、ターゲットの状態が `healthy` になるまで一定時間ポーリングする。
- 期限内に `healthy` にならなければ異常とみなし、CI を失敗させる。
- 標準の待機コマンドに依存するのではなく、自前のループで状態と経過時間をログに残す構成にしている。

#### 8. CloudWatch Logs の構造化ログ確認

- アプリケーションのログは、1 行 JSON 形式で CloudWatch Logs に送っている前提。
- 一時 ALB 経由で `/healthz` `/dbcheck` を叩いたあと、ロググループを検索し、
  - 該当するルートのログが出力されているか
  - 期待しているフィールド（例：`route` やステータスコード）が入っているか
  を確認し、その一部を証跡として抜き出しておく。
- これにより、「ALB 経由でリクエストが到達し、構造化されたログとして記録されている」ことまでカバーできる。

### 実行フロー（ざっくり）

このスモーク CI の流れを高レベルでまとめると、次のようになる。

1. アプリケーションのルーティングを静的に確認し、ヘルスチェック用エンドポイントの存在を確認する。  
2. DB 接続情報と RDS 実体のエンドポイント・ポートに差異がないかをチェックする。  
3. Terraform で一時的な ALB / ターゲットグループ / ALB 用セキュリティグループを作成する。  
4. 実行中の ECS タスクから IP アドレスとセキュリティグループを取得する。  
5. 一時 ALB から ECS タスクへの通信を許可するルールをセキュリティグループに追加する。  
6. ALB が有効な AZ と ECS タスクの AZ が一致しているか確認する。  
7. ECS タスクの IP をターゲットグループに登録する。  
8. HTTP:80 のリスナーを、一時ターゲットグループにフォワードするように設定する。  
9. ターゲットのヘルスチェックパスをヘルスチェック用エンドポイントに設定する。  
10. ターゲットがヘルシーな状態になるまで状態を監視する。  
11. 一時 ALB 経由でヘルスチェック用エンドポイントにアクセスし、レスポンスを記録する。  
12. CloudWatch Logs から、ヘルスチェック用リクエストに対応する構造化ログを取得して確認する。  
13. 途中で失敗した場合は、ターゲットヘルスやリスナー設定を追加で取得し、原因調査用の証跡として残す。  
14. 最後に、セキュリティグループの許可ルールを削除し、一時 ALB / ターゲットグループを Terraform で破棄する。  
15. 集めた証跡ファイルを専用ブランチにコミットし、ベースブランチ向けの PR を自動作成する。

### 証跡として残すもの

- 検証用 ALB / ターゲットグループの作成・破棄に関するログ（Terraform の実行結果など）。
- 一時 ALB 経由で叩いたヘルスチェック用エンドポイントの HTTP レスポンス。
- 該当リクエストに対応する CloudWatch Logs の構造化ログ（必要なフィールドのみ抽出）。
- エラー時には、ターゲットのヘルス状態やリスナー設定のスナップショットも追加で保存する。

これらをまとめて PR に載せておくことで、  
「いつ・誰が・どの構成に対してスモークテストを実行し、結果どうだったか」を後から辿れるようにしている。

### 典型的な失敗パターンと対策

- **DB 接続情報と RDS の不整合**  
  → シークレットと RDS 実体の情報のズレを検知し、ALB 作成前に CI を止める。

- **AZ ミスマッチによるターゲット未使用 (`unused`)**  
  → ALB と ECS タスクの AZ を比較し、合っていなければ疎通テストに進まずにエラーにする。

- **セキュリティグループ設定漏れによるヘルスチェック失敗**  
  → CI 内で一時的に許可ルールを追加し、終了時に必ず削除するフローにしている。

- **HTTP リスナーの競合や誤ったターゲットへのフォワード**  
  → 既存のリスナーを考慮しつつ、一時ターゲットグループが必ずデフォルトの転送先になるよう冪等に更新する。

### セキュリティ上の配慮

- 証跡としてコミットするファイルには、RDS の詳細なエンドポイントやパスワードなどの機微情報は含めない設計にしている。
- DB 接続内容やシークレットの値は、必要に応じて CI のログ上でのみ確認し、リポジトリ内（Git 管理の証跡）には残さない。
- CI から利用する IAM ロールは、
  - シークレットの参照
  - RDS / ECS / ALB / EC2（ネットワーク関連） / CloudWatch Logs の状態参照・最小限の更新
  に必要な範囲に絞り、「検証用の一時リソースを作って壊す」ための権限だけを持つようにしている。