---
title: "CI: Audit Evidence（CloudTrail/Config 24h・別WF）"
---

## CloudTrail / Config のオンデマンド証跡取得 CI

### 目的

- 必要なタイミングでのみ、CloudTrail と AWS Config の情報をまとめて取得し、監査用の証跡としてリポジトリに保存する。
- アプリのスモークテスト CI とは分離し、「監査ログを取りたいときだけ手動実行する」ワークフローとして運用する。

### 前提（IAM / 対象範囲）

- GitHub Actions から Assume する IAM ロールに、CloudTrail のイベント参照と Config の設定参照に必要な最小限の権限を付与している。
- ターゲットのリージョンは `us-west-2` に固定し、このリージョンの CloudTrail / Config の状態を取得する。
- 取得対象は、Papyrus 関連のインフラ（ALB / ECS / EC2 / RDS / Secrets Manager 等）に関わるイベントや設定に限定する方針。

### 設計の要点

#### スモーク CI と分離している理由

- CloudTrail / Config の情報は以下の性質があり、通常のスモークテストと混ぜると扱いづらいため分離している。
  - データ量が多くなりやすく、CI 全体の実行時間・ログ量を押し上げる。
  - 監査色が強く、日常のデプロイや疎通確認とは関係のない情報も含まれる。
- そのため、この CI はスケジュール実行ではなく手動トリガー (`workflow_dispatch`) のみとし、
  「直近 24 時間分を必要なときだけ取る」という運用にしている。

#### CloudTrail イベントのフィルタ方針

- 直近 24 時間の CloudTrail イベントのうち、次のいずれかに該当するものだけを抽出している。
  - イベントの発行元サービスが、ALB / ECS / EC2 / RDS / Secrets Manager に該当する。
  - リソース名に「Papyrus のシステム名や ALB / ターゲットグループ / サービス / タスク / セキュリティグループ / サブネット / VPC」など、関連キーワードが含まれている。
- これにより、Papyrus と無関係なイベントを大幅に除外し、サイズとノイズを抑えた監査証跡にしている。

#### AWS Config の扱い

- Config については、設定状態（Configuration Recorder / Delivery Channel）がどうなっているかをスナップショットとして取得する。
- Config が未設定の場合や、一時的に権限が足りない場合でも、CI 全体が失敗しないように設計している。
  - 取得できた場合は「現在の記録・配信の設計」が分かる。
  - 取得できなかった場合でも、その状態自体をレビューのきっかけとして扱える。

### 実装ポイント

#### CloudTrail / Config の抽出と保存

- 直近 24 時間を対象に、CloudTrail のイベントを絞り込み、Papyrus 関連の操作イベントだけを 1 つのファイルにまとめて保存する。
  - イベントが 0 件でも、「24 時間分を確認した」という事実が分かるように、空の結果を含めて保存する。
- AWS Config については、設定内容のスナップショットを取得して保存する。
  - Config が無効な環境では、ファイルが空に近い状態になるため、その差分から「まだ Config を有効化していない」という判断ができる。

#### PR 自動作成のフロー

- 取得した監査用ファイルは、`dev` ブランチから派生した専用ブランチにコミットし、自動で PR を作成する。
  - ブランチ名には「audit」と実行時刻を含め、いつの 24 時間分かが分かるようにしている。
  - PR のタイトルとラベルから「監査証跡用の PR」であることが一目で分かるようにしている。
- 取得結果に差分が無い場合（新たに追加された監査ファイルがない場合）は、PR を作成せずに終了する。

### 証跡として扱う情報

- 直近 24 時間分の CloudTrail イベントのうち、Papyrus のインフラに関連したものをまとめた JSON ファイル。
- AWS Config の設定状態を表す JSON ファイル（Configuration Recorder / Delivery Channel の構成）。
- これらはすべて `docs/evidence` 以下に保存し、監査・振り返り・構成レビューに利用できるようにしている。

### 失敗パターンと対応方針

- **CloudTrail の権限不足**
  - イベント取得に必要な権限が不足している場合は CI がエラーで終了する。
  - 対応として、CI 用ロールに CloudTrail の参照権限を追加し、対象アカウント・リージョンが正しいかを確認する。
- **AWS Config 未設定 / 権限不足**
  - Config 側の取得に失敗しても、CI 全体は止めずに続行する。
  - 取得結果を確認し、「Config を使った継続的な監査が必要かどうか」を別途検討する。
- **対象イベントが 0 件**
  - フィルタ条件に合致するイベントがない場合も、そのまま 0 件として保存する。
  - Papyrus 関連の操作が発生していない 24 時間であった、という判断材料にする。

### セキュリティ上の配慮

- CloudTrail の生イベントには、IAM ユーザー名や IP アドレス、リソースの ARN など機微な情報が含まれるため、以下のような制約を設けている。
  - 対象のサービスとリソース名を絞り込み、不要なイベントは保存しない。
  - 証跡の保存先は開発用リポジトリ内に限定し、公開リポジトリには含めない。
- さらに厳密な運用が必要な場合は、IP アドレスやユーザー名の追記マスクや、証跡ブランチの定期削除などを追加検討できるようにしている。