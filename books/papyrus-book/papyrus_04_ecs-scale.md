---
title: "CI: ECS Scale（手動 DesiredCount 制御）"
---

## ECSタスク数の手動スケーリング（停止専用）

### 目的

- 検証用の ECS サービスを、**「使うときだけ起動する」ための停止専用ワークフロー**として用意する。
- 起動は別ワークフローでタスク数を 1 にしてデプロイし、  
  停止は本ワークフローでタスク数を 0 にして全タスクを停止する、という二段構成にしている。
- スケジューラではなく、**運用担当が明示的に「起動」「停止」を実行する運用**とし、  
  使っていない時間帯の Fargate 実行コストを削減する。

### 前提（停止 / 再開ポリシー）

- 対象はあくまで **ECS サービス単位**であり、クラスター名・サービス名は事前に固定している。
- どの環境を止めてよいか、どの時間帯に誰が実行してよいかは、運用ルール側で定義する。
  - 例：本番は対象外とし、検証用クラスターだけ夜間・休日に停止してよい、など。
- CI 自体には時間帯制御などは持たせず、**誤操作は IAM 権限と運用ルールで防ぐ**前提にしている。

### ワークフロー設計

#### トリガーと入力

- 手動実行専用のワークフロー（`workflow_dispatch`）。
- 実行時に「タスク数」を入力できるようにしているが、
  - デフォルト値は 0（= サービス停止）。
  - 実運用では **停止用途に限定して使う**想定にしている。
- 起動側ワークフローでは、「タスク定義の更新」と「タスク数を 1 にするデプロイ」をセットで実施する。

#### コスト最適化と業務時間

- 典型的な運用イメージ：
  - 日中：起動側ワークフローでタスク数を 1 にし、最小構成で検証できる状態にしておく。
  - 夜間・休日：本ワークフローでタスク数を 0 にし、リソースを停止してコストを抑える。
- 将来的にはスケジュール自動化も可能だが、  
  まずは「誰がいつ止めた／動かしたか」を明示的に残せる手動トリガーから始めている。

### 実装ポイント

#### DesiredCount の変更

- ワークフローがやっていることはシンプルで、  
  **指定された ECS サービスの DesiredCount を入力値に更新するだけ**の処理になっている。
- サービス更新の結果は AWS 側で非同期に反映されるため、  
  このワークフロー内では「サービスが安定状態になるまで待機する」といった処理は行っていない。
- 状態確認が必要な場合は、コンソールや別途用意したコマンドから、サービスの状態やタスク数を確認する想定。

#### 影響範囲（接続断）

- タスク数を 0 にすると、対象サービスのタスクはすべて停止するため、
  - そのサービスを背後に持つロードバランサーのターゲットもなくなり、新規リクエストは失敗する。
- 再起動時（タスク数を 1 以上に戻すとき）は、アプリ側の初期化処理（DB 接続・マイグレーションなど）が  
  複数回実行されても問題にならない設計になっていることが前提。

### 証跡の扱い

- 本ワークフロー自体は、サービス状態のスナップショットをファイルとして保存するような実装にはしていない。
- 証跡としては、次の情報に依存している。
  - GitHub Actions の実行履歴（誰がいつ、どの値で実行したか）
  - CloudTrail の API 呼び出し履歴（サービス更新の記録）
  - ECS サービスイベント（スケールイン / スケールアウトの履歴）
- もし、より厳密な証跡が必要であれば、  
  サービス状態の取得結果をリポジトリ内の証跡ディレクトリに出力するステップを追加することもできる。

### 失敗例と対策

- **クラスター名 / サービス名の誤り**
  - 対象のクラスターやサービスが存在しない場合、サービス更新 API の呼び出し自体が失敗する。
  - 対策として、クラスター名・サービス名はリポジトリの設定（変数）で固定し、レビュー対象にしている。

- **権限不足 / スロットリング**
  - サービス更新の権限が CI 用ロールに付与されていない場合、即時にエラーとなる。
  - 頻繁にスケール操作を行うと API 制限に引っかかる可能性もあるため、実行頻度や対象環境を運用ルールで絞る。

### セキュリティ上の配慮

- CI 用の IAM ロールには、少なくとも「特定の ECS サービスの DesiredCount を更新する権限」のみを与え、  
  不要な ECS 操作（サービス作成や削除など）は許可しない。
- 理想的には、
  - デプロイ用ロール（タスク定義の更新や新バージョンの反映を行う）
  - スケール操作用ロール（DesiredCount の変更だけを行う）
  を分けておき、  
  「サービスの構成を変えられる人」と「タスク数だけ触れる人」を明確に分離できるようにしている。