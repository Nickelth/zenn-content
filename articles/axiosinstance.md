---
title: "axiosInstance内部にAuth0書いたら毎回読み込まれてクソ重案件になった話"
emoji: "💥"
type: "tech"
topics: ["auth0", "typescript", "セキュリティ"]
published: false
---

## コンポ単位でAuth0たたきすぎでページ遷移クソ重

※実務で得た知見を個人環境で再現したもので構成しています。

### 課題概要

課題：SPAのWebアプリでページ遷移が重い
言語：TypeScript

原因：
①axiosInstance.insterceptor内でAuth0アクセストークン呼び出し処理を記述。
② ①のファイルをコンポーネント単位で読み込んでいたことで、1ページ当たり11回の読込が実行されていた。

対応案（未実施）：Auth0でのセッション確認は、１遷移ごとに行う仕様にする。検索処理など、１ページで完結するコンポーネントでは確認しない。

### 総評

* **原因特定の妥当性: A**
  コンポーネント単位の import で `axios.interceptors.request.use` が多重登録され、**1遷移あたり11回のトークン取得**が走る構造は再現性のあるボトルネック。筋が通ってる。

* **影響度の評価: A-**
  トークン取得はネットワーク往復や暗号処理を伴うため、N倍化すれば体感遅延に直結。11倍は普通に致命的。

* **対応案の方向性: B+**
  「セッション確認を“1遷移ごと”に限定」「ページ完結コンポーネントは確認しない」は冗長呼び出しの主要因を潰す発想として妥当。

### 気になる論点（評価観点）

※あくまで評価ポイント。やり方の提案ではない。

1. **「1遷移」の定義の曖昧さ**
   SPAの内部遷移、クエリパラメータ変化、タブ間移動などで境界がぶれやすい。仕様の粒度が曖昧だと再発余地あり。

2. **同時実行と重複抑止**
   ルート遷移直後に複数 API が並列発火するケースで、セッション確認が競合・重複するリスク。評価上の盲点。

3. **期限切れ境界の扱い**
   ページ滞在中にトークンが失効した場合の再取得条件と、401発生時のリカバリ方針。ここが緩いと“たまに落ちる”が残る。

4. **不要付与の防止精度**
   「認証不要のAPIには付けない」は正しいが、判定ロジックが雑だと誤付与や漏れが起きる。評価ではこの分類基準の明確さが鍵。

5. **副作用モジュールの多重読込に弱い構成**
   設定ファイルの import 副作用が UI 構成の変化（コンポーネント増減）に敏感。設計的に再発しやすい地雷原、という評価。

### スコアカード

* 根本原因の特定: **A**
* 対応案の実効性: **B+**
* 仕様の明確性: **B-**
* 並列時の安定性配慮: **C+**
* セキュリティ整合性（不要付与の抑止含む）: **B**

### 結論

方向は合ってる。主因の“多重登録によるN倍トークン取得”に直撃している点は評価高い。仕上げで「遷移の定義」「並列時の重複」「失効時の扱い」を詰めないと、再発と“たまに遅い/たまに落ちる”が残る。インターセプタをコンポーネントで読み回した罪は重いが、更生の余地はある。






### STAR分析

#### S（状況）

- SPA（TypeScript）でページ遷移時に体感遅延。

- 各コンポーネントが読み込み時にaxiosInstance.interceptorでAuth0アクセストークン取得を実行。

#### T（課題）

- 認証トークン取得を1遷移あたり1回に抑え、API呼び出しに安全に添付。

- 認証不要のAPIにはそもそもトークンを付けない。

- インターセプタの多重登録・多重発火を排除。

#### A（対応/検討中）

トークン取得の単一化：アプリ起動時に単一のAxiosクライアントを作成。インターセプタは1度だけ設定。

トークンプロバイダ導入：getAccessTokenSilently()の呼び出しをラップし、**メモリキャッシュ＋同時実行の集約（in-flight promise）**で重複取得を防止。

ルート単位のセッション確認：ルーティング変更時にだけセッション確認）。

認証不要リクエストのフラグ：config.skipAuth = trueでインターセプタをバイパス。

計測：遷移TTI、トークン取得回数、API成功率をログ出し。

#### R（結果/期待）

トークン取得回数：11回/ページ → 1回/遷移。

遷移待ちの同時APIがトークン待ちで渋滞→排除。

認証不要APIの速度→純粋にネットワークだけのコストに。
※数字は構成上の上限/下限であり、実測は下の計測で確認。