---
title: "【業務紹介】PHPサイト/Ubuntuサーバー保守PJ"
emoji: "🧭"
type: "idea"
topics: ["ubuntu","bash","postgresql","linux","php","apache","cli"]
published: false
---

## 社内向けPHPサイト/Ubuntuサーバ運用記事

### 抄録

SQLエラーログに個人情報が混入する問題を、**INSERT限定対応ではなく全書き込み系の共通ハンドリング**と**ログ脱敏のホワイトリスト化**で解決する方針に整理。

### TL;DR

* 目的: ログからPIIを排除しつつ調査性を維持
* 決定: 例外をSQLSTATEで正規化、許可キーのみ構造化出力
* 非採用: 生メッセージやVALUES羅列の出力、INSERT限定対処

### スコープ/非スコープ

* スコープ: 例外正規化、ログ脱敏、監視転送のサニタイズ
* 非スコープ: 既存機能の大幅改修

### 使用技術

* PHP、PostgreSQL、Ubuntu、cron、ログ集約

### 構成図（1枚）

* 書込み系→共通ハンドラ→構造化ログ→転送（サニタイズ）

### Decision Log

| テーマ   | 採用              | 捨てた理由        |
| ----- | --------------- | ------------ |
| 例外正規化 | SQLSTATEベースで定型化 | 生文言はPII含有    |
| ログ方針  | ホワイトリスト許可のみ     | ブラックリストは抜け漏れ |
| 監視転送  | 送出前スクラバー必須      | APMが勝手に値を添付  |

### 設計の要点

* ログに残すのは「操作種別・テーブル名・分類コード・件数・時刻」
* VALUESやパラメータは記録しない
* INSERT/UPDATE/UPSERT/バルクすべて共通ハンドラ通過

### リスクと緩和

* 抜け漏れ → グローバル最終ゲートで正規化強制
* 監視ツールの自動添付 → スクラバーで削除、CIでPIIパターン検査

### 今後の改善

* 詳細は権限管理された隔離保管へ、通常ログは要約のみ

---

## 仕上げミニチェックリスト（全記事共通）

* [ ] 抄録200字内、TL;DR 4行以内
* [ ] 図1枚、表1枚、Decision Log表あり
* [ ] スコープ/非スコープ明記
* [ ] 「採用しなかった理由」を必ず1つ以上
* [ ] 個人情報・機密ゼロ、実務名は匿名化

この型で、再現実験ゼロでも“判断と構成”で押し切れる。時間が足りないなら、図は四角と矢印だけにして出す。文章は短く、決定と理由は濃く。