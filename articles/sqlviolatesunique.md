---
title: "SQLエラー | インシデント復旧（原因と最短復旧の意思決定）"
emoji: "⌨"
type: "tech"
topics: ["sql", "postgres", "php", "cli"]
published: false
---

※実務で得た知見を個人環境で再現したもので構成しています。

## 抄録（差し替え）

当日勤怠の反映に障害が発生。原因は、CSVの一意制約違反により挿入時にエラーが発生したこと。契約外のためCSV生成側は改修対象外とし、別部門でCSV修正後、**当該PHPのみ**を再実行して復旧した。復旧過程で、SQLエラーログに個人情報が出力されていることを確認。恒久対策は別稿（第二段階）で扱う。

## 背景と目的（軽修正）

背景: 当日勤怠の反映が停止。
目的: 影響最小で**当日中の復旧**を達成すること。

## 制約（据え置き）

* CSV生成は契約外。設計書なし、引継ぎ不十分。
* PHPは毎朝、勤務時間外に cron 実行。

## 代替案と評価軸（復旧方法・表の磨き込み）

| 代替案 | 効果 | 影響範囲 | 工数/期間 | リスク | 判定 |
| --- | --- | ---- | ----: | --- | --- |
| 日次タスク一式をシェルで再実行 | 高 | 広い | 大 | 成功済み処理の重複・再実行に伴う副作用 | 不採用 |
| **当該PHPのみを再実行** | 中 | 狭い | 小 | 依存順序の検証が必要 | **採用** |
| 失敗レコードのみ再投入（補助スクリプト） | 中  | 中 | 中 | 抽出条件の誤りで欠落・重複の恐れ | 保留 |

## 結果と教訓（短く）

* 影響範囲の増大を避け、当該PHPのみの再実行で復旧。
* 復旧中に**ログへ個人情報が出力**されている事実を確認。恒久対策は第二段階へ分離。

