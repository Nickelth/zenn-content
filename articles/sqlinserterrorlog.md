---
title: "SQLエラー対策 | 個人情報が漏れるログ設計の是正（恒久対策）"
emoji: "⌨"
type: "tech"
topics: ["sql", "postgres", "php", "cli"]
published: false
---

※実務で得た知見を個人環境で再現したもので構成しています。

## 抄録（差し替え）

復旧時に、SQLエラーログへ個人情報が出力される事象を確認。**Insert文を try-catch で囲う**だけでは情報露出の根本対策にならないため、アプリ層での**ログ脱敏**と**エラー詳細の出力方針**を再設計する。

### 目的（明確化）

* 失敗時にも復旧に必要な情報のみを記録し、個人情報（氏名、住所、電話、メール、社員IDなど）が**ログに残らない**こと。

### 制約（踏襲）

* 既存実装の大改修は不可。段階的対応が前提。

### 代替案と評価軸（個人情報漏洩対策・表の埋め直し）

| 代替案 | 効果 | 影響範囲 | 工数/期間 | リスク | 判定 |
| --- | --- | --- | --- | --- | --- |
| DBドライバの生エラーをそのままログ出力  | 低 | 広い | 小 | 個人情報が平文で残存 | 不採用 |
| **Insertを try-catch で囲い、アプリ側でエラー整形** | 中 | 狭い | 小 | 実装差異で漏れ残りのリスク | **採用（第1手）** |
| **ログ脱敏（マスキング/ホワイトリスト）を導入**  | 高 | 中 | 中 | 初期整備が必要 | **採用（同時）**  |
| エラー詳細をセキュアストアに隔離（例: 暗号化専用シンク）し、通常ログは要約のみ | 中  | 中 | 中 | 参照に権限管理が要る | 併用検討 |

### 採用方針

1. **アプリ層で例外を捕捉し、構造化メッセージで出力（テーブル名・エラー分類・件数のみ）**
2. **ログ脱敏**: メッセージ生成時にホワイトリスト方式で許可されたキーのみ記録。データ値は原則マスク。
3. **詳細は隔離**: 原因調査が必要な場合のみ、権限管理された保管先に詳細を出す運用に切り替え。

### 設計の要点

**ログ方針**: 「誰が」「いつ」「どの処理で」「何件失敗」を記録し、**個別の値は記録しない**。
* **データ分類**: 個人情報のフィールドを**明示列挙**し、ログ生成時に常に除外/マスク。
* **エラー分類**: 一意制約違反・外部キー違反・型不整合などを**分類コード**で記録。値は持たない。
* **観測可能性**: 失敗件数と失敗率をダッシュボード化。個別レコード情報が不要な設計に寄せる。
* **段階移行**: まず try-catch と脱敏を導入、次に詳細ログの隔離と権限付与を進める。

### 失敗と再発防止

* **catch したのに PII が紛れ込む**
  対策: ログ生成は**ホワイトリスト**方式。ブラックリスト運用はやめる。
* **運用が原因で詳細ログが乱造**
  対策: 詳細ログの出力は**機能トグル**とし、期限付きで有効化。監査ログに出力者と理由を残す。
* **調査に必要な情報が不足**
  対策: 要調査の場合のみ、テーブル名・主キー・件数・時刻の**メタ情報**を使ってリプロ。個別値をログに書かない運用を徹底。

### 仕上げチェック（5項目）

* 抄録に「復旧」「ログ漏洩確認」「恒久対策は別稿」を全部入れたか
* 復旧の代替案表に「失敗レコードのみ再投入」を入れて“不採用”理由を書いたか
* 第二段階の表が「try-catchだけで終わらない」構成になっているか
* ログ方針が**ホワイトリスト**で明文化されているか
* 証拠（発生ログの時刻分布スクショ、修正後の失敗率グラフ）を用意したか
